# Payment System


### 1. Checkout 기능 구현
- 동일한 요청 파라미터로 N번 요청을 보내도 1번만 수행되어야 한다면? -> 멱등성 보장
  - 따닥 이슈, 네트워크 이슈로 동일한 주문에 대해 N번 결제를 요청했을 때 N번의 결제가 이루어지면 안됨.
  - 이런 일이 생기지 않도록 하기 위해 결제 API는 [멱등성](https://docs.tosspayments.com/blog/what-is-idempotency)을 보장할 수 있어야 한다.
  - 멱등성을 보장하기 위해 멱등성 Key가 필요한데 이번 구현에서는 Checkout 시점에 멱등성 Key를 만들고 orderId로 저장한다.
  - 결국, 동일한 주문을 식별할 수 있는 Key값을 결제 멱등성 Key로 사용한다.
  - 그런데 `동일한 주문`을 어떻게 볼 것인가를 먼저 고민해봐야 할 것 같다.
  - 현재 tossPayment 결제 페이지로 들어가는 시점에 orderId를 만든다.
  - 하지만 실제 이커머스 서비스에서는 주문/결제 페이지에 진입하는 시점에 `동일한 주문을 식별하는 ID` = `멱등성 Key`를 만든다.

### 2. 재처리 시도
- 재시도 시 고려할 사항
  - `Exponential backoff`
    - 재시도 사이에 일정 시간 지연을 설정하는 것이다. 서버가 과부하로 인해 응답을 전달하지 못하는 경우를 대비해서 일정시간 지연 시간은 재시도마다 지수적으로 증가한다. 
    - 예를 들면, 첫 번째 재시도에는 1초 동안 대기하고, 두 번째 재시도에는 2초 대기, 세 번째 재시도에는 4초 대기, 네 번째 재시도에는 8초 대기 후 재시도를 수행한다.
  - `Jitter`
    - 여러 요청이 동시에 재시도 되면서 서버 과부하의 원인이 될 수 있기 때문에 Exponential 외에도 무작위 지연을 추가로 부여하는 것이다.
  - `Retry Limited Count`
    - 무한으로 재시도를 수행하며 서버 자원을 소모시키는 것을 방지하기 위한 최대 재처리 횟수
- 타임아웃
  - 타임아웃 종류와 서비스 성격에 맞춰 적절한 타임아웃을 설정해 리소스를 효율적으로 관리해야 한다.
  - 한 요청이 리소스를 독점하지 않도록...
    - 연결 타임아웃(Connection Timeout): 서버와의 연결을 시도할 때까지의 시간을 말한다. 
    - 요청 타임아웃(Request Timeout): 요청을 보낸 후 서버로부터 응답을 받기까지의 시간을 말한다.


### 3. 결제 복구 시스템
- 웹 요청과 별도의 분리된 자원으로 복구 로직 수행하기 -> Bulk Head Pattern
  - 스케줄러를 통해 결제 복구 시스템을 구현한다.
  - 이때 스케줄러가 사용하는 ThreadPool을 분리해 서비스의 웹 요청과 리소스를 분리해 서로의 영향을 줄인다.
  - 하지만 실제 서비스에서는 결제 복구 시스템을 동일 서비스의 스케줄러로 두지 않을 것 같다.
  - Bulk Head Pattern도 간단히 시도할 수 있는 격리 방법이지만, 별도의 배치로 돌려서 API 서버와 공유하는 리소스는 DB만 두는 게 좋아 보인다.
- Scalability 고려하기
  - 현재 구현처럼 API 서버에 Scheduler로 결제 복구 시스템을 두면 Scale을 늘리면 중복 처리의 가능성이 발생한다.
  - 가장 간단히는 Lock을 활용해 동시에 수행이 안 된도록 할 수 있다.
  - 단, Scale을 늘려 처리량을 높이고 싶다면 `Partitioning`을 통해 각 POD가 접근할 데이터를 분리해야 한다.